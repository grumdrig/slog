<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>PQ Slog: Chinbreak Island</title>
<link rel="icon" type="image/svg+xml" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: 512px; width: 512px;"><path d="M0 0h512v512H0z" fill="black" fill-opacity="1"></path><g class="" transform="translate(0,0)" style=""><path d="M19.75 14.438c59.538 112.29 142.51 202.35 232.28 292.718l3.626 3.75.063-.062c21.827 21.93 44.04 43.923 66.405 66.25-18.856 14.813-38.974 28.2-59.938 40.312l28.532 28.53 68.717-68.717c42.337 27.636 76.286 63.646 104.094 105.81l28.064-28.06c-42.47-27.493-79.74-60.206-106.03-103.876l68.936-68.938-28.53-28.53c-11.115 21.853-24.413 42.015-39.47 60.593-43.852-43.8-86.462-85.842-130.125-125.47-.224-.203-.432-.422-.656-.625C183.624 122.75 108.515 63.91 19.75 14.437zm471.875 0c-83.038 46.28-154.122 100.78-221.97 161.156l22.814 21.562 56.81-56.812 13.22 13.187-56.438 56.44 24.594 23.186c61.802-66.92 117.6-136.92 160.97-218.72zm-329.53 125.906l200.56 200.53c-4.36 4.443-8.84 8.793-13.405 13.032L148.875 153.53l13.22-13.186zm-76.69 113.28l-28.5 28.532 68.907 68.906c-26.29 43.673-63.53 76.414-106 103.907l28.063 28.06c27.807-42.164 61.758-78.174 104.094-105.81l68.718 68.717 28.53-28.53c-20.962-12.113-41.08-25.5-59.937-40.313 17.865-17.83 35.61-35.433 53.157-52.97l-24.843-25.655-55.47 55.467c-4.565-4.238-9.014-8.62-13.374-13.062l55.844-55.844-24.53-25.374c-18.28 17.856-36.602 36.06-55.158 54.594-15.068-18.587-28.38-38.758-39.5-60.625z" fill="white" fill-opacity="1"></path></g></svg>' />
<link rel=stylesheet href="node_modules/xp.css/dist/XP.css">
<link rel=stylesheet href="os.css">
<script src="vm.js"></script>
<script src="os.js"></script>
<script src="joy.js"></script>
<script src="dwarfname.js"></script>
<script src="slayer.jstrat"></script>
<script src="quester.jstrat"></script>
<script src="ChinbreakIsland_v1.js"></script>
<style>
#newstuff {
	min-width: 240px;
	display: grid;
	grid-template-columns: 40px 1fr;
}
#newstuff > div {
	grid-column: 1/3;
}

fieldset {
	background-color: transparent;
}
#strat-author, #strat-title, #strat-length, #s-d-m {
	background: #efefef;
}
#strat-author, #strat-title, #strat-length {
	padding: 2px;
	border: solid 1px rgb(208,208,191);
	border-radius: 4px;
}
#strat-desc {
	width: 200px;
}
#sold {
	grid-column: 1/3;
	text-align: center;
	margin-top: 4px;
}
fieldset > .field-row {
	margin-top: 4px;
	margin-bottom: 4px;
}
#strat {
	margin-bottom: 6px;
	margin-top: -6px;
}
hr { margin: 16px }

div.icon > div {
	text-shadow: 0 0 2px white, 0 0 3px white;
}
#fetchStrat {
	padding: 0;
	min-height: 19px;
	min-width: 60px;
	height: 19px;
}

div.accross {
	display: grid;
	grid-template-columns: 200px 1fr;
	column-gap: 8px;
}

#stats button {
	min-width:  19px;
	min-height: 19px;
	padding: 0;
	font-size: 12px;
}

#stats {
	display: grid;
	grid-template-columns: 85px 19px 30px 19px 30px;
}

#stats > legend {
	grid-column: 1/6;
}

#stats .s, #schooling {
	text-align: center;
	border: inset 1px silver;
	margin: 0 2px;
}

#stats .sa {
	text-align: center;
}

#schooling {
	margin-bottom: 8px;
}

</style>
</head>
<body>

<div class=window hidden id=game-window>
	<div class="title-bar">
		<div class="title-bar-text">Loading...</div>
		<div class="title-bar-controls">
			<button aria-label="Close" class=close></button>
		</div>
	</div>

	<div class=window-body></div>
</div>

<div class=window id=newgame-window>
	<div class="title-bar">
		<div class="title-bar-text">New Game</div>
		<div class="title-bar-controls">
			<button aria-label="Close" class=close></button>
		</div>
	</div>
	<div class=window-body>
		<div id=newstuff>

			<div class=accross>
				<div>
					<fieldset>
						<legend>Name</legend>
						<input type=text id=namein value=Artaud></input>
					</fieldset>

					<fieldset id=selectSpecies>
						<legend>Species</legend>
						<div class="field-row">
						  <input id="Dunkling" type="radio" name=species value=1 checked>
						  <label for="Dunkling">Dunkling</label>
						</div>

						<div class="field-row">
						  <input id="Hardwarf" type="radio" name=species value=2>
						  <label for="Hardwarf">Hardwarf</label>
						</div>

						<div class="field-row">
						  <input id="Eelman" type="radio" name=species value=3>
						  <label for="Eelman">Eelman</label>
						</div>
					</fieldset>

					<fieldset id=stats>
						<legend>Starting Stats</legend>
<div>Available</div><div></div><div id=schooling></div><div></div><div></div>

<div>Strength </div><button>&ndash;</button><div class=s></div><button>+</button><div class=sa></div>
<div>Agility  </div><button>&ndash;</button><div class=s></div><button>+</button><div class=sa></div>
<div>Endurance</div><button>&ndash;</button><div class=s></div><button>+</button><div class=sa></div>
<div>Intellect</div><button>&ndash;</button><div class=s></div><button>+</button><div class=sa></div>
<div>Wisdom   </div><button>&ndash;</button><div class=s></div><button>+</button><div class=sa></div>
<div>Charisma </div><button>&ndash;</button><div class=s></div><button>+</button><div class=sa></div>
					</fieldset>
				</div>

				<div>
					<fieldset id=strat>
						<legend>Strategy</legend>

						<div class="field-row">
						  <input type="radio" name=strat value=quester id=quester checked>
						  <label for="quester">Plotline Chester</label></input>
						</div>

						<div class="field-row">
						  <input type="radio" name=strat value=slayer id=slayer>
						  <label for="slayer">Slayer Freebird</label></input>
						</div>

						<div class="field-row">
						  <input type="radio" name=strat value=uploaded id=uploaded>
						  <label for="uploaded">Upload:&nbsp;
							  <input type="file" name="client-file" id="file" accept=".strat" />
						  </label></input>
						</div>

						<div>
						  <input type="radio" name=strat value=orurl id=orurl>
						  <label for="orurl">URL:&nbsp;
							  <input type="url" id=straturl></input>&nbsp;
							  <button id=fetchStrat>Fetch</button>
						  </label></input>
						</div>

						<br/>
						<div>...or <a href=ide.html>program your own!</a></div>

						<hr/>

						<div class=field-row style="display:grid;grid-template-columns:1fr 4fr;">
							<label for=strat-title>Title</label><div id=strat-title>&nbsp;</div>
							<label for=strat-author style=margin-left:0>Author</label><div id=strat-author>&nbsp;</div>
							<label for=strat-length style=margin-left:0>Length</label><div id=strat-length>&nbsp;</div>
						</div>
						<fieldset class=field-row style="grid-column:1/3" id=s-d-m>
								<legend>Description</legend>
								<div class=field-row id=strat-desc>&nbsp;</div>
						</fieldset>
					</fieldset>
				</div>
			</div>
			<div id=sold><button disabled onclick="sold()">Go!</button></div>
		</div>
	</div>
</div>

<div class=window hidden id=map-window>
	<div class="title-bar">
		<div class="title-bar-text">Map</div>
		<div class="title-bar-controls">
			<button aria-label="Close" class=close></button>
		</div>
	</div>

	<div class="window-body">
		<img src=chinbreak_map.png width=800px></img>
	</div>
</div>



<div class=icon data-for=game-window>
	<img src=game.png>
	<div>Game</div>
</div>

<div class=icon data-for=newgame-window>
	<img src=game.png>
	<div>New Game</div>
</div>

<div class=icon data-for=map-window>
	<img src=map.png>
	<div>Map</div>
</div>

<script>

let vm;


//hide("#chooser");


const desktop_glsl = `

vec3 rand(vec3 xyz) {
	return fract(vec3(sin(dot(xyz, vec3(43.238, 27.874, 57.982))),
					  sin(dot(xyz, vec3(91.922, 11.838, 77.133))),
					  sin(dot(xyz, vec3(43.238, 27.874, 57.982))))*
				 vec3(9283.9502,8329.9128,3201.1984));
}


vec3 curp(vec3 v0, float t, vec3 v1) {
	t = t * t * (3.0 - 2.0 * t);
	return mix(v0, v1, t);
}

vec3 lerp(vec3 v0, float t, vec3 v1) {
	return mix(v0, v1, t);
}

vec3 noise(vec3 xyz) {
	vec3 v0 = floor(xyz);
	vec3 f = xyz - v0;
	return
	  curp(curp(lerp(rand(v0),               f.z, rand(v0 + vec3(0,0,1))),
				f.y,
				lerp(rand(v0 + vec3(0,1,0)), f.z, rand(v0 + vec3(0,1,1)))),
		   f.x,
		   curp(lerp(rand(v0 + vec3(1,0,0)), f.z, rand(v0 + vec3(1,0,1))),
				f.y,
				lerp(rand(v0 + vec3(1,1,0)), f.z, rand(v0 + vec3(1,1,1)))));
}

vec3 simplex(vec3 xyz, int octaves) {
	float a = 1.0;
	vec3 result = vec3(0);
	for (int o = 1 << octaves; o > 0; o >>= 1, a /= 2.) {
		result += (2. * noise(xyz / float(o)) - 1.) * a;
	}
	return result;
}


void mainImage( out vec4 fragColor, in vec2 fragCoord ) {
	vec2 uv = fragCoord/iResolution.x - vec2(0.5, 0.5 * iResolution.y / iResolution.x);
	vec3 per = simplex(vec3(uv * 120., iTime * 2.0), 5);
	per = normalize(per);
	float a = dot(per, normalize(vec3(uv, 0.1)));
	a = 1. * pow(a, 5.);
	a = 1. - a;
	fragColor.rgb = per * a * 1.;
	fragColor.rgb = 0.1 + 0.8 * fragColor.rgb;
	fragColor.rgb = vec3(1.0) - fragColor.rgb;
	fragColor.rgb = 0.25 * fragColor.rgb + vec3(0.4, 0.45, 0.6);
	fragColor.a = 1.0;
}


`;

let PACKAGE;
let STRATEGIES = {};
let STATS = new Array(6).fill(0);
let SCHOOLING;

window.addEventListener('load', e => {
	let game = ChinbreakIsland_v1;
	$("#game-window .title-bar-text").innerHTML = game.title;
	$("#game-window .window-body").innerHTML = game.windowContent;

	shaderjoy(desktop_glsl);

	prepOS();

	show('#newgame-window');
	hide('#game-window');

	$('#namein').value = generateName();

	$$('#selectSpecies input').forEach((e, i) => {
		e.addEventListener('change', _ => speciesChanged(game));
	});
	speciesChanged(game);

	SCHOOLING = game.initialTraining;
	$('#schooling').innerText = SCHOOLING;
	$$('#stats button').forEach((b, i) => {
		let statindex = i >> 1;
		let statElement = $$('#stats .s')[statindex];
		statElement.innerText = STATS[statindex];
		let inc = (i & 1) * 2 - 1;
		b.addEventListener('click', e => {
			SCHOOLING -= inc;
			$('#schooling').innerText = SCHOOLING;
			STATS[statindex] += inc;
			statElement.innerText = STATS[statindex];
			restat();
		});
	});
	restat();

	$("input[type=file]").addEventListener('change', upload);

	$$('input[name=strat]').forEach(r => r.addEventListener('change', changeStrat));

	STRATEGIES.quester = quester;
	STRATEGIES.slayer = slayer;
	changeStrat();

	$('#straturl').addEventListener('select', e => { $('#orurl').checked = true });
	$('#fetchStrat').addEventListener('click', fetchUrlStrat);

	$('#namein').addEventListener('input', sellable);
	$('#namein').focus();
	sellable();
});

function speciesChanged(game) {
	let mods = STATS.map(_ => '');
	let species = $('[name=species]:checked').value;
	game.MOBS[species].abilityMods.forEach(m => {
		let {slot, increment} = m;
		if (increment > 0) increment = '+' + increment;
		mods[slot - Strength] = increment;
	});
	mods.forEach((mod, i) => {
		$$('#stats div.sa')[i].innerText = mod;
	});
}

function restat() {
	$$('#stats button').forEach((b, i) => {
		let statindex = i >> 1;
		let inc = !!(i & 1);
		if (inc) {
			b.disabled = SCHOOLING <= 0;
		} else {
			b.disabled = (STATS[statindex] <= 0);
		}
	});
}

function changeStrat() {
	let s = $('input[name=strat]:checked').value;
	setStrategy(STRATEGIES[s]);
	sellable();
}

function sellable() {
	$('#sold button').disabled = !PACKAGE || $('#namein').value.trim().length == 0;
}

function upload(e) {
	let f = e.target.files[0];
	if (!f) return;
	const reader = new FileReader()
	reader.onload = e => {
		const package = JSON.parse(e.target.result);
		STRATEGIES.uploaded = package;
		setStrategy(package);
		$('#uploaded').checked = true;
		sellable();
	};
	reader.readAsText(f);
}

function setStrategy(package) {
	PACKAGE = package;
	if (package) {
		$("#strat-title").innerText = package.title || '(untitled)';
		$("#strat-author").innerText = package.author || '(anonymous)';
		$("#strat-desc").innerText = package.description || '(no description)';
		$("#strat-length").innerText = (package.binary || []).length + ' bytes';
	} else {
		$("#strat-title").innerHTML = '&nbsp;';
		$("#strat-author").innerHTML = '&nbsp;';
		$("#strat-desc").innerHTML = '&nbsp;';
		$("#strat-length").innerHTML = '&nbsp;';
	}
}

function fetchUrlStrat() {
	fetch($('#straturl').value)
		.then(response => {
				return response.json();
			})
		.then(data => {
				STRATEGIES.orurl = data;
				setStrategy(STRATEGIES.orurl);
				$('#orurl').checked = true;
				sellable();
			})
		.catch(err => {
				console.error('err', err);
			})
}

let game;

function sold() {
	hide('#newgame-window');

	// loadBinary($('#orders').value, program => {
	// 	vm = new VirtualMachine(program, Chinbreak);
	// 	play();
	// });

	console.log();

	game = new ChinbreakIsland_v1(PACKAGE.binary,
		$('[name=species]:checked').value,
		$('#namein').value,
		...STATS);

	vm = new VirtualMachine(PACKAGE.binary, game);
	play();

}

function play() {

	show($id('game-window'));
	bringToFront($id('game-window'));
	// vm.running = true;
	ChinbreakIsland_v1.playmation(vm, false, 0);
}



</script>