<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>PQ Chasm</title>
<link rel="icon" type="image/svg+xml" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: 512px; width: 512px;"><path d="M0 0h512v512H0z" fill="black" fill-opacity="1"></path><g class="" transform="translate(0,0)" style=""><path d="M19.75 14.438c59.538 112.29 142.51 202.35 232.28 292.718l3.626 3.75.063-.062c21.827 21.93 44.04 43.923 66.405 66.25-18.856 14.813-38.974 28.2-59.938 40.312l28.532 28.53 68.717-68.717c42.337 27.636 76.286 63.646 104.094 105.81l28.064-28.06c-42.47-27.493-79.74-60.206-106.03-103.876l68.936-68.938-28.53-28.53c-11.115 21.853-24.413 42.015-39.47 60.593-43.852-43.8-86.462-85.842-130.125-125.47-.224-.203-.432-.422-.656-.625C183.624 122.75 108.515 63.91 19.75 14.437zm471.875 0c-83.038 46.28-154.122 100.78-221.97 161.156l22.814 21.562 56.81-56.812 13.22 13.187-56.438 56.44 24.594 23.186c61.802-66.92 117.6-136.92 160.97-218.72zm-329.53 125.906l200.56 200.53c-4.36 4.443-8.84 8.793-13.405 13.032L148.875 153.53l13.22-13.186zm-76.69 113.28l-28.5 28.532 68.907 68.906c-26.29 43.673-63.53 76.414-106 103.907l28.063 28.06c27.807-42.164 61.758-78.174 104.094-105.81l68.718 68.717 28.53-28.53c-20.962-12.113-41.08-25.5-59.937-40.313 17.865-17.83 35.61-35.433 53.157-52.97l-24.843-25.655-55.47 55.467c-4.565-4.238-9.014-8.62-13.374-13.062l55.844-55.844-24.53-25.374c-18.28 17.856-36.602 36.06-55.158 54.594-15.068-18.587-28.38-38.758-39.5-60.625z" fill="white" fill-opacity="1"></path></g></svg>' />
<script src="vm.js"></script>
<script src="pqasm.js"></script>
<script src="compiler.js"></script>
<link rel=stylesheet href="node_modules/xp.css/dist/XP.css"/>
<style>
	/* Styling for the character sheet */

	#sheet-window { width: 600px }

	#sheet {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 4px;
	}

	#col1, #col2, #col3 {
		grid-row: 1;
		display: grid;
		grid-template-columns: 1fr;
		gap: 4px;
		/*width: 300px;*/
	}
	#col1 { grid-column: 1; }
	#col2 { grid-column: 2; }
	#col3 { grid-column: 3; }
	#col1 > div, #col2 > div, #col3 > div {
		display: grid;
		grid-template-columns: 2fr 1fr;
	}
	#col2 > #equipment {
		grid-template-columns: 1fr 1fr;
	}
	#col3 > #environment { grid-template-columns: 2fr 3fr; }
	#col3 > #quest { grid-template-columns: 2fr 3fr; }
	#col3 > #plot { grid-template-columns: 1fr 1fr; }

	div.header {
		grid-column: 1 / 3;
		height: 14px;
	}

.listview {
	display: grid;
	grid-template-columns: repeat(2, 1fr);
	/*grid-auto-rows: 200px;*/
	gap: 2px;
	position: relative;
	border: inset 2px #ddd;
	background-color: white;
}
.listview div {
	/*padding-left: 2px;*/
	padding: 0 1px;
}
.listview .header {
	background-color: #ece9d8;
	border: outset 1px #ddd;
	border-right: groove 1px #ddd;
}

	.changed { background-color: yellow }

	.window { cursor: default }

	body {
		width: 100%;
		height: 100%;
		padding: 0;
		margin: 0;
		background-color: #afdeee;
	}


[role="progressbar"] {
	height: 15px;
	border: 1px solid #888;
	border-radius: 3px;
	overflow: hidden;
	background-color: white;
}
[role="progressbar"] > div {
	overflow: hidden;
	height: 13px;
	margin: 1px;
}
[role="progressbar"] > div:first-child {
	/*box-shadow: inset 0 0 1px #fff;*/
	background-color: #ace97c;
}
[role="progressbar"] > div:nth-child(2) {
	text-align: center;
	width: 100%;
}

[role="progressbar"] {
	position: relative;
}
[role="progressbar"] > * {
	position: absolute;
	top: 0;
	left: 0;
}

#task { margin: 1px 0 2px 0; }

.prog {
	border: 1px solid #888;
	border-radius: 3px;
	height: 11px; /* TODO this needs to be 12px to properly fit text inside but that's one pixel too big for the current space alloted to the other rows with just text, so we need to resolve that somehow */
	text-align: center;
	margin-right: 1px;
}


</style>
<style>
	/* Styling for the debug area */

	#sources textarea { width: 100%; }

	.button > br {
	  content: "";
	  margin: -1px;
	  display: block;
	}

	 #registers > pre {
	 	 border-bottom: dotted 1px silver;
	 	 margin-bottom: -1px;
	 }

	 #debugger {
		margin: 10px 0;
	 	display: grid;
	 	grid-template-columns: 370px 180px;
	 	width: auto;
	 }

	 #debugger hr { margin: 0 }

	 #debugger button { width: 100%; }
	 #debugger > div {
	 	border: solid 1px silver;
	 	padding: 4px;
	 }
	 #debugger > div.nobo {
	 		border: none;
	 	}
	 	#stack { background-color: white }
		.brain {
			overflow: auto;
			max-height: 112px;
		}
		#debugbar p { font: 13px monospace }

		#sources textarea {
			border: inset 1px silver;
		}

	.err {
		color: red;
	}

	#automom { margin: 4px }

	article { min-height: 280px; }

	 /* defeat some xp.css for the machine area */

	 div#sources pre,
	 div#debugger pre {
	 	padding: 0;
	 	font-size: 13px;
	 	background-color: white;
	 	color: black;
	 	font-family: monospace;
	 	margin: 0;
	 }

	 div#sources textarea,
	 div#debugger textarea {
	 	font-family: monospace;
	 	font-size: 13px;
	 }

	 div#sources button,
	 div#debugger button {
	 	min-width: 0px;;
	 	padding: 1px 6px;
	 }

	 #controls-window {
	 	width: 500px;
	 }

/* Icons */

div.icon {
	width: 64px;
	text-align: center;
	margin: 20px;
}


</style>
</head>
<body>

<div class=window id=editor-window>
	<div class="title-bar">
	  <div class="title-bar-text">Source Code Editor</div>
	  <div class="title-bar-controls">
	    <button aria-label="Close" class=close></button>
	  </div>
	</div>

	<div class="window-body" id="sources">
		<section class="tabs" style="XXmax-width: 500px">
		  <menu role="tablist" aria-label="Sample Tabs">
		    <button role="tab" aria-selected="true" aria-controls="tab-A">Source</button>
		    <button role="tab" aria-controls="tab-B">Assembly</button>
		    <button role="tab" aria-controls="tab-C">Disassembly</button>
		    <button role="tab" aria-controls="tab-D">Interface</button>
		  </menu>
		  <article role="tabpanel" id="tab-A">
				<textarea rows=16 cols=50 id=source></textarea><br/>
				<button onclick="comp()">Compile</button>
				<span style="margin-left: 10px">&nbsp;</span>
				<input type=checkbox id=autorun ><label for=autorun>Autorun</label></input>
		  </article>
		  <article role="tabpanel" hidden id="tab-B">
				<textarea rows=16 cols=50 id=asm></textarea>
				<button onclick="assemble()">Assemble</button>
		  </article>
		  <article role="tabpanel" hidden id="tab-C">
				<textarea readonly rows=18 cols=50 id=machine></textarea>
		  </article>
		  <article role="tabpanel" hidden id="tab-D">
				<textarea readonly rows=18 cols=50 id=interface></textarea>
		  </article>
		</section>
		<div class="status-bar">
	    <p class="status-bar-field" id=errors></p>
	  </div>
	</div>
</div>


<div class=window hidden id=debugger-window>
	<div class="title-bar">
	  <div class="title-bar-text">Debugger</div>
	  <div class="title-bar-controls">
	    <button aria-label="Close" class=close></button>
	  </div>
	</div>

	<div class="window-body">
		<div id=debugger>
			<span>Execution point</span>
			<span>Stack [<span id=stackdepth></span>]</span>

			<div id=codepoint></div>
			<div id=stack></div>

			<span>Registers &amp; State</span>
			<span>Memory</span>

			<div class=brain><div id=registers></div></div>
			<div class=brain><div id='memory'></div></div>
		</div>
		<div class=nobo>
			<button onclick="step()">Step</button>
			<button onclick="bigstep()">Bigstep</button>
			<button onclick="runimate()">Runimate</button>
			<button onclick="run()">Run</button>
			<button onclick="play()">Play</button>
			<button onclick="reset()">Reset</button>
		</div>
		<div class="status-bar" id=debugbar>
	    <p class="status-bar-field" id=r0>PC</p>
	    <p class="status-bar-field" id=r1>SP</p>
	    <p class="status-bar-field" id=r2>FP</p>
	    <p class="status-bar-field" id=r3>AX</p>
	    <p class="status-bar-field" id=r4>CK</p>
	  </div>
	</div>
</div>



<div class=window id=sheet-window>
	<div class="title-bar">
	  <div class="title-bar-text">Progress Quest Assembly - Character Sheet</div>
	  <div class="title-bar-controls">
	    <button aria-label="Close" class=close></button>
	  </div>
	</div>

	<div id=sheet class=window-body>
		<div id=col1>
			<div id=vitals class=listview>
				<div class=header>Vital Statistics</div>
				<div>Race</div><div id="race"></div>
				<div>Level</div><div id="level">1</div>
				<div>XP</div><div id="xp" class=prog>0</div>
				<div>Health</div><div id="health" class=prog>1</div>
				<div>Energy</div><div id="energy" class=prog>1</div>
			</div>

			<div id=stats class=listview>
				<div class=header>Stats</div>
				<div>Strength</div>     <div id="s0">1</div>
				<div>Agility</div>      <div id="s1">1</div>
				<div>Constitution</div> <div id="s2">1</div>
				<div>Intelligence</div> <div id="s3">1</div>
				<div>Wisdom</div>       <div id="s4">1</div>
				<div>Charisma</div>     <div id="s5">1</div>
			</div>

			<div id=spells class=listview>
				<div class=header>Spell Book</div>
				<div id=bt0>(none)</div> <div id="b0"></div>
				<div id=bt1>(none)</div> <div id="b1"></div>
				<div id=bt2>(none)</div> <div id="b2"></div>
				<div id=bt3>(none)</div> <div id="b3"></div>
			</div>
		</div>
		<div id=col2>
			<div id=equipment class=listview>
				<div class=header>Equipment	(Armor Class: <span id=armorClass></span>)</div>
				<div>Weapon</div>   <div id=e0></div>
				<div>Armor</div>    <div id=e1></div>
				<div>Shield</div>   <div id=e2></div>
				<div>Backpack</div> <div id=e3></div>
				<div>Footwear</div> <div id=e4></div>
				<div>Ring</div>     <div id=e5></div>
				<div>Amulet</div>   <div id=e6></div>
				<div>Mount</div>    <div id=e7></div>
			</div>
			<div id=inventory class=listview>
				<div class=header>Inventory
					(Encumbrance: <span id=encumbrance></span>/<span id=capacity></span>)</div>
				<div>Gold</div>            <div id=i0>10</div>
				<div>Drops</div>           <div id=i1>10</div>
				<div>Reagents</div>        <div id=i2>10</div>
				<div>Healing potions</div> <div id=i3>10</div>
				<div>Energy potions</div>  <div id=i4>10</div>
				<div>Rations</div>         <div id=i5>10</div>
				<div>Gems</div>            <div id=i6>10</div>
				<div>Sand</div>            <div id=i7>10</div>
			</div>
		</div>
		<div id=col3>
			<div id=environment class=listview>
				<div class=header>Environment</div>
				<div>Coordinates</div><div>#<span id=location></span> &lt;<span id=longitude></span>,<span id=latitude></span>&gt;</div>
				<div>Locale</div><div id=locale></div>
				<div>Terrain</div><div id=terrain></div>
				<div>Creature</div><div id=mob></div>
				<div>Damage</div><div id=mobDamage></div>
			</div>
			<div id=quest class=listview>
				<div class=header>Quest</div>
				<div>Object</div> <div id=questobject>Kill the selkies</div>
				<div>Location</div> <div id=questlocation>Chump woods</div>
				<div>Progress</div> <div id=questprogress class=prog>50%</div>
				<div>Origin</div> <div id=questorigin>Dojo town</div>
			</div>
			<div id=plot class=listview>
				<div class=header>Game Progress</div>
				<div>Act</div> <div id=act>II</div>
				<div>Act Progress</div> <div id=actprogress class=prog>50%</div>
				<div>Game Progress</div> <div id=gameprogress class=prog>50%</div>
			</div>
		</div>
	</div>
	<div id=task-area class=status-bar>
		<div class=status-bar-field>
			<div id=task >Loading...</div>
			<div id=taskbar role="progressbar" aria-valuemin=0 aria-valuemax=100 aria-valuenow=90>
				<div></div>
				<div></div>
			</div>
		</div>
	</div>
</div>

<br/>

<div class=window hidden id=controls-window>
	<div class="title-bar">
	  <div class="title-bar-text">Controls</div>
	  <div class="title-bar-controls">
	    <button aria-label="Close" class=close></button>
	  </div>
	</div>

	<div class="window-body">

		<label for=arg1>Arguments:</label>
			<input id=arg1 type=text value=0></input>
			<input id=arg2 type=text value=0></input>
		<br/>
		<span>Result: <code id=result>-</code></span>
		<br/>
		<br/>
		<button onclick="gameplay(train)">train(stat)</button>
		<button onclick="gameplay(study)">study(spell)</button>
		<button onclick="gameplay(initialize)">initialize(slot,value)</button>
		<button onclick="gameplay(travel)">travel(destination)</button>
		<button onclick="gameplay(melee)">melee()</button>
		<button onclick="gameplay(buy)">buyItem(slot,quantity)</button>
		<button onclick="gameplay(buy)">buyEquipment(slot,quality)</button>
		<button onclick="gameplay(sell)">sell(slot,quantity)</button>
		<button onclick="gameplay(seekquest)">seekquest()</button>
		<button onclick="gameplay(completequest)">completequest()</button>
		<button onclick="gameplay(cast)">cast(spell_slot)</button>
		<button onclick="gameplay(forage)">forage(target_slot)</button>
		<button onclick="gameplay(levelup)">levelup()</button>
		<button onclick="gameplay(start)">startGame()</button>
		<button onclick="gameplay(give)">give(slot,quantity)</button>
		<button onclick="gameplay(drop)">drop(slot,quantity)</button>

	</div>
</div>


<div class=window hidden id=map-window>
	<div class="title-bar">
	  <div class="title-bar-text">Map</div>
	  <div class="title-bar-controls">
	    <button aria-label="Close" class=close></button>
	  </div>
	</div>

	<div class="window-body">
		<img src=pqasm_map.png width=800px></img>
	</div>
</div>


<div class=icon data-for=editor-window>
	<img src=editor.png>
	<div>Editor</div>
</div>

<div class=icon data-for=sheet-window>
	<img src=game.png>
	<div>Game</div>
</div>

<div class=icon data-for=debugger-window>
	<img src=debugger.png>
	<div>Debugger</div>
</div>

<div class=icon data-for=controls-window>
	<img src=controls.png>
	<div>Controls</div>
</div>

<div class=icon data-for=map-window>
	<img src=map.png>
	<div>Map</div>
</div>

<script>

function $(s) { return document.querySelector(s) }
function $$(s) { return document.querySelectorAll(s) }
HTMLElement.prototype.$ = HTMLElement.prototype.querySelector;
function $id(s) { return document.getElementById(s) }

let asm, vm;


function saveChanges() {
	localStorage.source = $("#source").value;
	localStorage.autorun = JSON.stringify($("#autorun").checked);
}


window.addEventListener('unload', saveChanges);


function comp() {
	saveChanges();
	$("#errors").innerHTML = '&nbsp;';
	$("#errors").classList.remove("err");
	try {
		$("#asm").value = compile(Game.generateInterface(), $("#source").value);
		if (assemble()) {
			$("#errors").innerText = `Compiled length: ${asm.pc} words (memory size ${asm.code.length})`;
			if ($("#autorun").checked)
				run();
		}
	} catch (e) {
		let message;
		if (e instanceof ParseError) {
			message = 'Parse Error: ' + e.message;
		} else if (e instanceof SemanticError) {
			message = 'Semantic Error: ' + e.message;
		} else {
			message = 'Compilation Error: ' + e;
		}
		console.log(e);
		$("#errors").classList.add("err");
		$("#errors").innerText = message
	}
}


function assemble() {
	$("#errors").innerHTML = '&nbsp;';
	$("#errors").classList.remove("err");
	try {
		asm = Assembler.assemble($("#asm").value);
		$("#machine").value = asm.disassemble();
		reset();
		return true;
	} catch (e) {
		$("#errors").classList.add("err");
		$("#errors").innerText = e.toString();
	}

}

function step() {
	stopRunimation();
	vm.step();
	updateDebuggerState(vm);
	updateCharacterSheet(vm.state);
}

function bigstep() {
	stopRunimation();
	vm.bigstep();
	updateDebuggerState(vm);
	updateCharacterSheet(vm.state);
}

function stopRunimation() {
	if (runimate.timer) {
		clearTimeout(runimate.timer);
		runimate.timer = null
		$id('task').innerHTML = 'Paused';
		animate.progress = 0;
		setTaskBar();
	}
}

function runimate() {
  if (vm.alive()) {
		let calledOut = vm.step();
		updateDebuggerState(vm);
		if (calledOut) updateCharacterSheet(vm.state);
  	runimate.timer = setTimeout(runimate, 100);
  }
}

function run() {
	stopRunimation();
	vm.running = true;
  while (vm.alive()) {
		vm.step();
	}
	updateDebuggerState(vm);
	updateCharacterSheet(vm.state);
}

function play() {
	stopRunimation();
	vm.running = true;
	playmation();
}

function setTaskBar() {
	// setBar('task', animate.progress, animate.duration, 0, '#ace97c');
	let bar  = $('#taskbar > div:nth-child(1)');
	let text = $('#taskbar > div:nth-child(2)');
	if (animate.duration > 0) {
		let pct = 100 * animate.progress / animate.duration;
		bar.style.width = pct.toFixed(2) + "%";
		text.innerText = Math.round(pct) + '%';
	} else {
		bar.style.width = 0;
		text.innerText = "";
	}
}

function playmation() {
	let before = vm.state[AGE];
  while (vm.alive() && vm.state[AGE] == before) {
		vm.step();
	}
	animate.duration = 1000 * Math.round(Math.sqrt(2 * (vm.state[AGE] - before)));
	animate.progress = 0;
	$id('task').innerText = TASK;
	setTaskBar();
	runimate.timer = setTimeout(animate, 10);
}

function animate() {
	animate.progress += 10;
	setTaskBar();
	if (animate.progress >= animate.duration) {
		updateDebuggerState(vm);
		updateCharacterSheet(vm.state);
		if (vm.alive)
			runimate.timer = setTimeout(playmation, 1);
	} else {
		runimate.timer = setTimeout(animate, 10);
	}
}


function reset() {
	stopRunimation();
	vm = new VirtualMachine(asm.code, Game);
	updateDebuggerState(vm);
	updateCharacterSheet(vm.state);
}

function rand(m) { return Math.floor(Math.random() * m) }
function crand(s) { return s * (Math.random() - Math.random()) }


function saveWindowState() {
	let ws = {};
	Array.from($$(".window")).forEach(w => {
		ws[w.id] = {
			id: w.id,
			left: w.style.left,
			top: w.style.top,
			zIndex: w.style.zIndex,
			hidden: w.hasAttribute('hidden') }
	});
	localStorage.windowState = JSON.stringify(ws);
}


function prepWindow(hwnd) {
  let handle = hwnd.$(".title-bar");
  const keepinside = false;

  hwnd.style.left = (hwnd.offsetLeft + 80) + 'px';
  hwnd.style.top = hwnd.offsetTop + 'px';
  hwnd.style.position = 'absolute';

  // Load window state
  let ws = JSON.parse(localStorage.windowState || '{}');
  if (ws = ws[hwnd.id]) {
	  hwnd.style.left = ws.left;
	  hwnd.style.top = ws.top;
	  let z = parseInt(ws.zIndex);
	  if (!Number.isNaN(z)) {
	  	hwnd.style.zIndex = z;
	  	prepWindow.zIndex = Math.max(z, prepWindow.zIndex);
	  }
	  ws.hidden ? hwnd.setAttribute('hidden', true) : hwnd.removeAttribute('hidden');
	}

	(handle || hwnd).addEventListener("mousedown", e => {
		hwnd.dragOrigin = { x: hwnd.offsetLeft - e.pageX,
												y: hwnd.offsetTop  - e.pageY };
		e.preventDefault();
  });
  hwnd.addEventListener("mousedown", e => {
    hwnd.style.zIndex = prepWindow.zindex = (prepWindow.zindex || 1) + 1;
    saveWindowState();
    // e.preventDefault();
	});
	window.addEventListener("mousemove", e => {
		if (!e.which || !e.buttons) hwnd.dragOrigin = null;
		if (hwnd.dragOrigin) {
			let x = e.pageX + hwnd.dragOrigin.x;
			let y = e.pageY + hwnd.dragOrigin.y;
			if (keepinside) {
				x = Math.max(0, Math.min(x, document.body.clientWidth  - hwnd.offsetWidth));
				y = Math.max(0, Math.min(y, document.body.clientHeight - hwnd.offsetHeight));
			}
			hwnd.style.left = `${x}px`;
			hwnd.style.top  = `${y}px`;
	    saveWindowState();
		}
	});
}

// window.addEventListener('load', e => {

window.addEventListener("DOMContentLoaded", _ => {
  $$('[role="tab"]').forEach(tab => tab.addEventListener("click", changeTabs));

  $("#interface").value = Game.generateInterface();

  $$(".icon").forEach(element => element.addEventListener('click', e => {
  	let win = document.getElementById(element.getAttribute('data-for'));
  	if (win.hasAttribute('hidden')) {
	  	win.removeAttribute('hidden');
	  	win.style.left = rand(100) + 'px';
	  	win.style.top = rand(100) + 'px';
	  }
    win.style.zIndex = prepWindow.zindex = (prepWindow.zindex || 1) + 1;
    saveWindowState();
  }));

  $$(".close").forEach(element => element.addEventListener('click', e => {
  	element.parentElement.parentElement.parentElement.setAttribute('hidden', true);
    saveWindowState();
  }));

	Array.from($$(".window")).reverse().forEach(prepWindow);

	$("#source").value = localStorage.source || "// hello, world!";
	$("#autorun").checked = JSON.parse(localStorage.autorun || "false");
	comp();
});

$("#source").addEventListener('keypress', e => {
	if (e.keyCode === 13 && (e.shiftKey || e.ctrlKey || e.metaKey)) comp();
});

$("#asm").addEventListener('keypress', e => {
	if (e.keyCode === 13 && (e.shiftKey || e.ctrlKey || e.metaKey)) assemble();
});


function changeTabs(e) {
  const target = e.target;
  const parent = target.parentNode;
  const grandparent = parent.parentNode;

  // Remove all current selected tabs
  parent
    .querySelectorAll('[aria-selected="true"]')
    .forEach((t) => t.setAttribute("aria-selected", false));

  // Set this tab as selected
  target.setAttribute("aria-selected", true);

  // Hide all tab panels
  grandparent
    .querySelectorAll('[role="tabpanel"]')
    .forEach((p) => p.setAttribute("hidden", true));

  // Show the selected panel
  grandparent.parentNode
    .querySelector(`#${target.getAttribute("aria-controls")}`)
    .removeAttribute("hidden");
}


function updateDebuggerState(vm) {

	function regFmt(name, value) {
		return `${(name + ' '.repeat(23)).substr(0,23)} $${('0000'+value.toString(16)).substr(-4)} ${value}`;
	}

	// Registers & State
	let n = 0;
	for (let i = 0; i < vm.registers.length; ++i, ++n) {
		let address = -i - 1;
		let d = $("#registers").children[n] ||
						$("#registers").appendChild(document.createElement('pre'));
		d.innerText = regFmt(REGISTER_NAMES[address] || i, vm.registers[i]);

		let r = $("#r" + i);
		if (r) r.innerText = d.innerText;
	}
	if (!$("#registers").children[n])
		$('#registers').appendChild(document.createElement('hr'));
	n += 1;
	for (let i = 0; i < vm.state.length; ++i, ++n) {
		let d = $("#registers").children[n] ||
						$("#registers").appendChild(document.createElement('pre'));
		d.innerText = regFmt(SLOTS[i] || i, vm.state[i]);
	}

	$("#codepoint").innerText = '';
	for (let p = -3; p <= 3; ++p) {
		let d = $("#codepoint").appendChild(document.createElement('pre'));
		d.innerText = (vm.pc + p < 0 ? ' ' : asm.disassemble(vm.pc + p)) + '\n';
		if (p === 0) d.style.backgroundColor="yellow";
	}

	$("#stackdepth").innerText = vm.memory.length - vm.sp;
	$("#stack").innerText = '';
	for (let i = Math.min(vm.sp + 5, vm.memory.length - 1); i >= vm.sp; --i) {
		let d = $("#stack").appendChild(document.createElement('pre'));
		d.innerText = `${('000' + i).substr(-4)}: $${('0000'+vm.memory[i].toString(16)).substr(-4)} ${vm.memory[i]}`;
		if (i === vm.sp) d.style.backgroundColor="yellow";
		if (i === vm.fp) d.style.border='solid 1px black';
	}

	if (vm.memory.length < $("#memory").children.length)
		$("#memory").innerText = '';  // in case the vm has changed sizes
	for (let i = 0; i < vm.memory.length; ++i) {
		let d = $("#memory").children[i] || $("#memory").appendChild(document.createElement('pre'));
		d.innerText = `${('000' + i).substr(-4)}: $${('0000'+vm.memory[i].toString(16)).substr(-4)} ${vm.memory[i]}`;
	}
}


function setBar(id, value, end, start=0, color='#ace97c') {
	let progress = Math.round(100 * value / (end - start));
	let bi = `linear-gradient(left, ${color}, ${color} ${progress}%, transparent ${progress}%, transparent 100%)`
	$id(id).style.backgroundImage = bi;
	$id(id).style.backgroundImage = '-webkit-' + bi;
}


function updateCharacterSheet(state) {


	function unhilite() {
		$$('.changed').forEach(elt => elt.classList.remove('changed'));
		updateCharacterSheet.UNHILITE = null;
	}

	unhilite();

	function set(id, value) {
		value = value.toString();
		let elt = document.getElementById(id);
		if (elt.innerText !== value) {
			elt.innerText = value;
			if (!updateCharacterSheet.UNHILITE) {
				updateCharacterSheet.UNHILITE = setTimeout(unhilite, 2000);
			}
			elt.classList.add('changed');
		}
	}

	function setProgress(id, value, end, start = 0) {
		set(id, `${value} / ${end}`);
		setBar(id, value, end, start);
	}

	set('race', Game.RACE_NAMES[state[RACE]]);
	set('level', state[LEVEL]);
	setProgress('xp', state[XP],
			Game.xpNeededForLevel(state[LEVEL] + 1),
			Game.xpNeededForLevel(state[LEVEL]));
	setProgress('health', state[MAX_HP]-state[DAMAGE], state[MAX_HP]);
	setProgress('energy', state[MAX_MP]-state[FATIGUE], state[MAX_MP]);

	for (let i = 0; i < STAT_COUNT; ++i) {
		set('s' + i, state[STAT_0 + i] >> 8);
	}
	let n_spells = 0;
	for (let i = 0; i < SPELL_COUNT; ++i) {
		let l = state[SPELL_0 + i] >> 8;
		if (l) {
			set('bt' + n_spells, `Spell #${i}`);
			set('b' + n_spells, l);
			n_spells += 1;
		}
	}
	for (let i = 0; i < EQUIPMENT_COUNT; ++i) {
		set('e' + i, `+${state[EQUIPMENT_0 + i]} dagger`);
	}
	set('armorClass', state[ARMOR_CLASS]);

	for (let i = 0; i < INVENTORY_COUNT; ++i) {
		set('i' + i, state[INVENTORY_0 + i]);
	}
	set('encumbrance', state[ENCUMBRANCE]);
	set('capacity', state[CAPACITY]);

	if (!state[LEVEL]) return;

	let local = Game.MAP[state[LOCATION]];
	set('location', local.index);
	set('longitude', local.longitude || (local.index % 6));
	set('latitude', local.latitude || (local.index / 6) >> 0);
	set('locale', local.name);
	set('terrain', Game.TERRAIN_TYPES[local.terrain].name);
	set('mob', state[MOB_TYPE] ?
		`${Game.MOBS[state[MOB_TYPE]].name} (level ${state[MOB_LEVEL]})` : '');
	set('mobDamage', state[MOB_TYPE] ? state[MOB_DAMAGE] : '');

	let questal = Game.MAP[state[QUEST_LOCATION]];
	let original = Game.MAP[state[QUEST_ORIGIN]];
	set('questobject', state[QUEST_OBJECT]);
	set('questlocation', questal && (questal.name + ' #' + questal.index) || '');
	setProgress('questprogress', state[QUEST_PROGRESS], state[QUEST_QTY]);
	set('questorigin', original && (original.name + ' #' + original.index) || '');

	set('act', state[ACT] || 'Prologue');
	setProgress('actprogress', state[ACT_PROGRESS], state[ACT_DURATION]);
	set('gameprogress', `${Math.round(100 * state[ACT] / 10)}%`);
	setBar('gameprogress', state[ACT], 10);

	if (!vm.running) {
			$id('task').innerText = 'Halted.';
	}
	setTaskBar();
}


function gameplay(inst, arg1, arg2) {
	arg1 = arg1 || eval($("#arg1").value);
	arg2 = arg2 || eval($("#arg2").value);
	let result = Game.handleInstruction(vm.state, inst, arg1, arg2);
	$("#result").innerText = result;
	updateCharacterSheet(vm.state);
}
</script>