<!doctype html>
<head>
<meta charset="utf-8"/>
<title>PQ Chasm</title>
<script src="vm.js"></script>
<style>
	#sheet {
		display: grid;
		grid-template-columns: repeat(3, 190px);
		gap: 4px;
	}

	#col1, #col2, #col3 {
		grid-row: 1;
		display: grid;
		grid-template-columns: 1fr;
		gap: 4px;
		/*width: 300px;*/
	}
	#col1 { grid-column: 1; }
	#col2 { grid-column: 2; }
	#col3 { grid-column: 3; }
	#col1 div, #col2 div, #col3 div {
		display: grid;
		grid-template-columns: 120px 60px;
	}
	#col3 #log { grid-template-columns: 1fr; }
	#col2 #equipment {
		grid-template-columns: 80px 80px;
	}

	div {
		font: 14px "helvetica";
		font-weight: 100;
	}

	div.head {
		font-style: italic;
		font-size: 16px;
		margin-bottom: 4px;
		grid-column: 1 / 3;
	}

	.boxy {
		border: solid 5px;
		border-image-slice: 5;
		border-color: red;
	}

</style>
</head>
<body>
<textarea id=asm></textarea>
<textarea id=machine></textarea>
<button onclick="assemble()">Assemble</button>

<div id=sheet>
	<div id=col1>
		<div id=vitals class=boxy>
			<div class=head>Character Sheet</div>
			<div>Level</div> <div id="level">1</div>
			<div>XP</div>    <div id="xp">0</div>
			<div>Health</div> <div id="health">1</div>
			<div>Energy</div> <div id="energy">1</div>
		</div>

		<div id=stats class=boxy>
			<div>Strength</div> <div id="c38">1</div>
			<div>Agility</div> <div id="c39">1</div>
			<div>Constitution</div> <div id="c3A">1</div>
			<div>Intelligence</div> <div id="c3B">1</div>
			<div>Wisdom</div> <div id="c3C">1</div>
			<div>Charisma</div> <div id="c3D">1</div>
		</div>

		<div id=spells class=boxy>
			<div class=head>Spell Book</div>
			<div>Heal</div> <div id="s0">I</div>
			<div>Fireball</div> <div id="s1">I</div>
			<div>Dig</div> <div id="s2">I</div>
			<div>Fly</div> <div id="s3">I</div>
		</div>
	</div>
	<div id=col2>
		<div id=equipment class=boxy>
			<div class=head>Equipment</div>
			<div>Weapon</div> <div>+1 Dagger</div>
			<div>Armor</div> <div>+1 Dagger</div>
			<div>Shield</div> <div>+1 Dagger</div>
			<div>Backpack</div> <div>+1 Dagger</div>
			<div>Footwear</div> <div>+1 Dagger</div>
			<div>Ring</div> <div>+1 Dagger</div>
			<div>Amulet</div> <div>+1 Dagger</div>
			<div>Boat</div> <div>+1 Dagger</div>
		</div>
		<div id=inventory class=boxy>
			<div class=head>Inventory</div>
			<div>Gold</div> <div>10</div>
			<div>Drops</div> <div>10</div>
			<div>Reagents</div> <div>10</div>
			<div>Healing potions</div> <div>10</div>
			<div>Energy potions</div> <div>10</div>
			<div>Rations</div> <div>10</div>
			<div>Gems</div> <div>10</div>
		</div>
	</div>
	<div id=col3>
		<div id=environment class=boxy>
			<div>Location</div><div>&lt;23,45&gt;</div>
		</div>
		<div id=log class=boxy>
			<div class=head>Log</div>
			<div>Stardate 2022</div>
		</div>
	</div>
</div>

<script>

function $(s) { return document.querySelector(s) }
function $$(s) { return document.querySelectorAll(s) }

function assemble() {
	let asm = new Assembler();
	asm.parse($("#asm").value);
	asm.link();
	$("#machine").value = asm.disassemble();
}

function rand(m) { return Math.floor(Math.random() * m) }
function crand(s) { return s * (Math.random() - Math.random()) }

function handline(svg, wiggle, X1, Y1, X2, Y2) {
	let x1, y1;
	let length = Math.sqrt(Math.pow(X2-X1, 2) + Math.pow(Y2-Y1, 2));
	let n = Math.round(length / 50);
	for (let i = 0; i <= n; i += 1) {
		x2 = (X1 + i/n * (X2-X1) + crand(wiggle)).toFixed(1);
		y2 = (Y1 + i/n * (Y2-Y1) + crand(wiggle)).toFixed(1);
		if (typeof x1 !== 'undefined') {
			let line = svg.appendChild(
						document.createElementNS('http://www.w3.org/2000/svg', 'line'));
			line.setAttribute('x1', x1);
			line.setAttribute('y1', y1);
			line.setAttribute('x2', x2);
			line.setAttribute('y2', y2);
			line.setAttribute('stroke', "black");
			line.setAttribute('stroke-width', (1.0 + crand(0.25)).toFixed(1) + "px");
		}
		x1 = x2;
		y1 = y2;
	}
}

function boxIn(div) {
	let IN = 2;
	let W = div.offsetWidth;
	let H = div.offsetHeight;
	let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
	svg.setAttribute('version', '1.1');
	svg.setAttribute('width',  W);
	svg.setAttribute('height', H);
	svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');

	let wiggle = IN * 0.75;

	handline(svg, wiggle, IN-1,   IN,     W-0-IN, IN    ); // N
	handline(svg, wiggle, IN,     IN-1,   IN,     H-0-IN); // W
	handline(svg, wiggle, IN-1,   H-1-IN, W-0-IN, H-1-IN); // S
	handline(svg, wiggle, W-1-IN, IN-1,   W-1-IN, H-0-IN); // E

	div.style.borderImageSource = `url('data:image/svg+xml,${svg.outerHTML}'`;
}

$$(".boxy").forEach(div => boxIn(div));

let asm = new Assembler();
asm.assemble('');
let world = new World(`
WWWWWW
W__t_W
WWWWWW`);
let vm = new VirtualMachine(asm.code, world);
$('#level').innerText = vm.special[SPECIAL.LEVEL];
$('#xp').innerText = vm.special[SPECIAL.EXPERIENCE];
$('#health').innerText = vm.special[SPECIAL.HEALTH];
$('#energy').innerText = vm.special[SPECIAL.ENERGY];

</script>