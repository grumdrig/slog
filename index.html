<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>PQ Chasm</title>
<link rel="icon" type="image/svg+xml" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="height: 512px; width: 512px;"><path d="M0 0h512v512H0z" fill="black" fill-opacity="1"></path><g class="" transform="translate(0,0)" style=""><path d="M19.75 14.438c59.538 112.29 142.51 202.35 232.28 292.718l3.626 3.75.063-.062c21.827 21.93 44.04 43.923 66.405 66.25-18.856 14.813-38.974 28.2-59.938 40.312l28.532 28.53 68.717-68.717c42.337 27.636 76.286 63.646 104.094 105.81l28.064-28.06c-42.47-27.493-79.74-60.206-106.03-103.876l68.936-68.938-28.53-28.53c-11.115 21.853-24.413 42.015-39.47 60.593-43.852-43.8-86.462-85.842-130.125-125.47-.224-.203-.432-.422-.656-.625C183.624 122.75 108.515 63.91 19.75 14.437zm471.875 0c-83.038 46.28-154.122 100.78-221.97 161.156l22.814 21.562 56.81-56.812 13.22 13.187-56.438 56.44 24.594 23.186c61.802-66.92 117.6-136.92 160.97-218.72zm-329.53 125.906l200.56 200.53c-4.36 4.443-8.84 8.793-13.405 13.032L148.875 153.53l13.22-13.186zm-76.69 113.28l-28.5 28.532 68.907 68.906c-26.29 43.673-63.53 76.414-106 103.907l28.063 28.06c27.807-42.164 61.758-78.174 104.094-105.81l68.718 68.717 28.53-28.53c-20.962-12.113-41.08-25.5-59.937-40.313 17.865-17.83 35.61-35.433 53.157-52.97l-24.843-25.655-55.47 55.467c-4.565-4.238-9.014-8.62-13.374-13.062l55.844-55.844-24.53-25.374c-18.28 17.856-36.602 36.06-55.158 54.594-15.068-18.587-28.38-38.758-39.5-60.625z" fill="white" fill-opacity="1"></path></g></svg>' />
<script src="vm.js"></script>
<script src="pqasm.js"></script>
<script src="compiler.js"></script>
<link rel=stylesheet href="node_modules/xp.css/dist/XP.css"/>
<style>
	/* Styling for the character sheet */

	 .window {
	 	width: 600px;
	 }


	#sheet {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 4px;
	}

	#col1, #col2, #col3 {
		grid-row: 1;
		display: grid;
		grid-template-columns: 1fr;
		gap: 4px;
		/*width: 300px;*/
	}
	#col1 { grid-column: 1; }
	#col2 { grid-column: 2; }
	#col3 { grid-column: 3; }
	#col1 > div, #col2 > div, #col3 > div {
		display: grid;
		grid-template-columns: 2fr 1fr;
	}
	#col2 > #equipment {
		grid-template-columns: 1fr 1fr;
	}
	#col3 > #environment { grid-template-columns: 2fr 3fr; }
	#col3 > #quest { grid-template-columns: 2fr 3fr; }
	#col3 > #plot { grid-template-columns: 1fr 1fr; }

	div.header {
		grid-column: 1 / 3;
		height: 14px;
	}

.listview {
	display: grid;
	grid-template-columns: repeat(2, 1fr);
	/*grid-auto-rows: 200px;*/
	gap: 2px;
	position: relative;
	border: inset 2px #ddd;
	background-color: white;
}
.listview div {
	/*padding-left: 2px;*/
	padding: 0 1px;
}
.listview .header {
	background-color: #ece9d8;
	border: outset 1px #ddd;
	border-right: groove 1px #ddd;
}

	.changed { background-color: yellow }

	.window { cursor: default }

	body {
		width: 100%;
		height: 100%;
		padding: 0;
		margin: 0;
	}

</style>
<style>
	/* Styling for the debug area */

	#sources textarea { width: 100%; }

	.button > br {
	  content: "";
	  margin: -1px;
	  display: block;
	}

	 #registers > pre {
	 	 border-bottom: dotted 1px silver;
	 	 margin-bottom: -1px;
	 }

	 #machinestate {
		margin: 10px 0;
	 	display: grid;
	 	grid-template-columns: 250px 100px 370px 250px 250px;
	 }

	 #machinestate button { width: 100%; }
	 #machinestate > div {
	 	border: solid 1px silver;
	 	padding: 4px;
	 }
	 #machinestate > div.nobo {
	 		border: none;
	 	}
		.brain {
			overflow: auto;
			max-height: 112px;
		}

	.err {
		color: red;
	}

	#automom { margin: 4px }

	article { min-height: 280px; }

	 /* defeat some xp.css for the machine area */

	 div#sources pre,
	 div#machinestate pre {
	 	padding: 0;
	 	font-size: 13px;
	 	background-color: white;
	 	color: black;
	 	font-family: monospace;
	 	margin: 0;
	 }

	 div#sources textarea,
	 div#machinestate textarea {
	 	font-family: monospace;
	 	font-size: 13px;
	 }

	 div#sources button,
	 div#machinestate button {
	 	min-width: 0px;;
	 	padding: 1px 6px;
	 }

</style>
</head>
<body>

<div class=window id="sources">
	<div class="title-bar">
	  <div class="title-bar-text">Source Code Editor</div>
	  <div class="title-bar-controls">
	    <button aria-label="Close"></button>
	  </div>
	</div>

	<div class="window-body">
		<section class="tabs" style="XXmax-width: 500px">
		  <menu role="tablist" aria-label="Sample Tabs">
		    <button role="tab" aria-selected="true" aria-controls="tab-A">Source</button>
		    <button role="tab" aria-controls="tab-B">Assembly</button>
		    <button role="tab" aria-controls="tab-C">Disassembly</button>
		  </menu>
		  <article role="tabpanel" id="tab-A">
				<textarea rows=16 cols=80 id=source></textarea>
				<button onclick="comp()">Compile</button>
		  </article>
		  <article role="tabpanel" hidden id="tab-B">
				<textarea rows=16 cols=15 id=asm></textarea>
				<button onclick="assemble()">Assemble</button>
		  </article>
		  <article role="tabpanel" hidden id="tab-C">
				<textarea rows=18 cols=25 id=machine></textarea>
		  </article>
		</section>
		<div class="status-bar">
	    <p class="status-bar-field" id=errors>Press F1 for help</p>
	  </div>
	</div>
</div>


<div id=machinestate>
	<span>Registers</span>
	<span></span>
	<span>Execution point</span>
	<span>Stack [<span id=stackdepth></span>]</span>
	<span>Memory</span>

	<div class=brain><div id=registers></div></div>
	<div class=nobo>
		<button onclick="step()">Step</button><br/>
		<button onclick="runimate()">Runimate</button><br/>
		<button onclick="run()">Run</button><br/>
		<div id=automom>
			<input type=checkbox id=autorun><label for=autorun>Autorun</label></input><br/>
		</div>
		<button onclick="reset()">Reset</button>
	</div>
	<div id=codepoint></div>
	<div id=stack></div>
	<div class=brain><div id=memory></div></div>
</div>



<div class=window>
	<div class="title-bar">
	  <div class="title-bar-text">Progress Quest Assembly - Character Sheet</div>
	  <div class="title-bar-controls">
	    <button aria-label="Close"></button>
	  </div>
	</div>

	<div id=sheet class=window-body>
		<div id=col1>
			<div id=vitals class=listview>
				<div class=header>Vital Statistics</div>
				<div>Race</div><div id="race"></div>
				<div>Level</div><div id="level">1</div>
				<div>XP</div><div id="xp">0</div>
				<div>Health</div><div id="health">1</div>
				<div>Energy</div><div id="energy">1</div>
			</div>

			<div id=stats class=listview>
				<div class=header>Stats</div>
				<div>Strength</div>     <div id="s0">1</div>
				<div>Agility</div>      <div id="s1">1</div>
				<div>Constitution</div> <div id="s2">1</div>
				<div>Intelligence</div> <div id="s3">1</div>
				<div>Wisdom</div>       <div id="s4">1</div>
				<div>Charisma</div>     <div id="s5">1</div>
			</div>

			<div id=spells class=listview>
				<div class=header>Spell Book</div>
				<div id=bt0>(none)</div> <div id="b0"></div>
				<div id=bt1>(none)</div> <div id="b1"></div>
				<div id=bt2>(none)</div> <div id="b2"></div>
				<div id=bt3>(none)</div> <div id="b3"></div>
			</div>
		</div>
		<div id=col2>
			<div id=equipment class=listview>
				<div class=header>Equipment	(Armor Class: <span id=armorClass></span>)</div>
				<div>Weapon</div>   <div id=e0></div>
				<div>Armor</div>    <div id=e1></div>
				<div>Shield</div>   <div id=e2></div>
				<div>Backpack</div> <div id=e3></div>
				<div>Footwear</div> <div id=e4></div>
				<div>Ring</div>     <div id=e5></div>
				<div>Amulet</div>   <div id=e6></div>
				<div>Mount</div>    <div id=e7></div>
			</div>
			<div id=inventory class=listview>
				<div class=header>Inventory
					(Encumbrance: <span id=encumbrance></span>/<span id=capacity></span>)</div>
				<div>Gold</div>            <div id=i0>10</div>
				<div>Drops</div>           <div id=i1>10</div>
				<div>Reagents</div>        <div id=i2>10</div>
				<div>Healing potions</div> <div id=i3>10</div>
				<div>Energy potions</div>  <div id=i4>10</div>
				<div>Rations</div>         <div id=i5>10</div>
				<div>Gems</div>            <div id=i6>10</div>
				<div>Sand</div>            <div id=i7>10</div>
			</div>
		</div>
		<div id=col3>
			<div id=environment class=listview>
				<div class=header>Environment</div>
				<div>Coordinates</div><div>#<span id=location></span> &lt;<span id=longitude></span>,<span id=latitude></span>&gt;</div>
				<div>Locale</div><div id=locale></div>
				<div>Terrain</div><div id=terrain></div>
				<div>Creature</div><div id=mob></div>
				<div>Damage</div><div id=mobDamage></div>
			</div>
			<div id=quest class=listview>
				<div class=header>Quest</div>
				<div>Object</div> <div id=questobject>Kill the selkies</div>
				<div>Location</div> <div id=questlocation>Chump woods</div>
				<div>Progress</div> <div id=questprogress>50%</div>
				<div>Origin</div> <div id=questorigin>Dojo town</div>
			</div>
			<div id=plot class=listview>
				<div class=header>Game Progress</div>
				<div>Act</div> <div id=act>II</div>
				<div>Act Progress</div> <div id=actprogress>50%</div>
				<div>Game Progress</div> <div id=gameprogress>50%</div>
			</div>
		</div>

	</div>
</div>

<br/>

<div class=window>
	<div class="title-bar">
	  <div class="title-bar-text">Controls</div>
	  <div class="title-bar-controls">
	    <button aria-label="Close"></button>
	  </div>
	</div>

	<div class="window-body">

<label for=arg1>Arguments:</label>
	<input id=arg1 type=text value=0></input>
	<input id=arg2 type=text value=0></input>
<br/>
<span>Result: <code id=result>-</code></span>
<br/>
<br/>
<button onclick="gameplay(train)">train(stat)</button>
<button onclick="gameplay(train, STAT_STRENGTH)">+Strength</button>
<button onclick="gameplay(train, STAT_AGILITY)">+Agility</button>
<button onclick="gameplay(train, STAT_CONSTITUTION)">+Constitution</button>
<button onclick="gameplay(train, STAT_INTELLIGENCE)">+Intelligence</button>
<button onclick="gameplay(train, STAT_WISDOM)">+Wisdom</button>
<button onclick="gameplay(train, STAT_CHARISMA)">+Charisma</button>
<br/>
<button onclick="gameplay(study)">study(spell)</button>
<button onclick="gameplay(initialize)">initialize(slot,value)</button>
<button onclick="gameplay(travel)">travel(destination)</button>
<button onclick="gameplay(melee)">melee()</button>
<button onclick="gameplay(buy)">buyItem(slot,quantity)</button>
<button onclick="gameplay(buy)">buyEquipment(slot,quality)</button>
<button onclick="gameplay(sell)">sell(slot,quantity)</button>
<button onclick="gameplay(seekquest)">seekquest()</button>
<button onclick="gameplay(completequest)">completequest()</button>
<button onclick="gameplay(cast)">cast(spell_slot)</button>
<button onclick="gameplay(forage)">forage(target_slot)</button>
<button onclick="gameplay(levelup)">levelup()</button>
<button onclick="gameplay(start)">startGame()</button>
<button onclick="gameplay(give)">give(slot,quantity)</button>
<button onclick="gameplay(drop)">drop(slot,quantity)</button>

	</div>
</div>


<script>

function $(s) { return document.querySelector(s) }
function $$(s) { return document.querySelectorAll(s) }
HTMLElement.prototype.$ = HTMLElement.prototype.querySelector;

let asm, vm;

function comp() {
	localStorage.source = $("#source").value;
	localStorage.autorun = JSON.stringify($("#autorun").checked);
	try {
		$("#asm").classList.remove("err");
		$("#asm").value = compile(generateInterface() + $("#source").value);
		assemble();
		if ($("#autorun").checked)
			run();
	} catch (e) {
		console.log(e);
		$("#asm").classList.add("err");
		$("#asm").value = e.message;
	}
}


function assemble() {
	asm = new Assembler();
	try {
		asm.assemble($("#asm").value);
		$("#machine").classList.remove("err");
		$("#machine").value = asm.disassemble();
		reset();
	} catch (e) {
		$("#machine").classList.add("err");
		$("#machine").value = e.toString();
	}

}

function step() {
	vm.step();
	updateDebuggerState(vm);
	updateCharacterSheet(vm.state);
}

function runimate() {
  if (vm.alive()) {
    step();
  	setTimeout(runimate, 100);
  }
}

function run() {
  while (vm.alive()) {
		vm.step();
	}
	updateDebuggerState(vm);
	updateCharacterSheet(vm.state);
}

function reset() {
	vm = new VirtualMachine(asm.code, Game);
	updateDebuggerState(vm);
	updateCharacterSheet(vm.state);
}

function rand(m) { return Math.floor(Math.random() * m) }
function crand(s) { return s * (Math.random() - Math.random()) }


function prepWindow(hwnd) {
	console.log(hwnd);
  let handle = hwnd.$(".title-bar");
  const keepinside = false;

  hwnd.style.left = (hwnd.offsetLeft + 60) + 'px';
  hwnd.style.top = hwnd.offsetTop + 'px';
  hwnd.style.position = 'absolute';

	(handle || hwnd).addEventListener("mousedown", e => {
		hwnd.dragOrigin = { x: hwnd.offsetLeft - e.pageX,
												y: hwnd.offsetTop  - e.pageY };
		e.preventDefault();
  });
  hwnd.addEventListener("mousedown", e => {
    hwnd.style.zIndex = prepWindow.zindex = (prepWindow.zindex || 1) + 1;
    // e.preventDefault();
	});
	window.addEventListener("mousemove", e => {
		if (!e.which || !e.buttons) hwnd.dragOrigin = null;
		if (hwnd.dragOrigin) {
			let x = e.pageX + hwnd.dragOrigin.x;
			let y = e.pageY + hwnd.dragOrigin.y;
			if (keepinside) {
				x = Math.max(0, Math.min(x, document.body.clientWidth  - hwnd.offsetWidth));
				y = Math.max(0, Math.min(y, document.body.clientHeight - hwnd.offsetHeight));
			}
			hwnd.style.left = `${x}px`;
			hwnd.style.top  = `${y}px`;
		}
	});
}

// window.addEventListener('load', e => {

window.addEventListener("DOMContentLoaded", _ => {
  const tabs = document.querySelectorAll('[role="tab"]');
  const tabList = document.querySelector('[role="tablist"]');

  // Add a click event handler to each tab
  tabs.forEach((tab) => {
    tab.addEventListener("click", changeTabs);
  });

	/*
  // Enable arrow navigation between tabs in the tab list
  let tabFocus = 0;

  tabList.addEventListener("keydown", (e) => {
    // Move right
    if (e.keyCode === 39 || e.keyCode === 37) {
      tabs[tabFocus].setAttribute("tabindex", -1);
      if (e.keyCode === 39) {
        tabFocus++;
        // If we're at the end, go to the start
        if (tabFocus >= tabs.length) {
          tabFocus = 0;
        }
        // Move left
      } else if (e.keyCode === 37) {
        tabFocus--;
        // If we're at the start, move to the end
        if (tabFocus < 0) {
          tabFocus = tabs.length - 1;
        }
      }

      tabs[tabFocus].setAttribute("tabindex", 0);
      tabs[tabFocus].focus();
    }
  });
  */

	Array.from($$(".window")).reverse().forEach(prepWindow);

	$("#source").value = localStorage.source || "main {\n}";
	$("#autorun").checked = JSON.parse(localStorage.autorun || "false");
	comp();
});

$("#source").addEventListener('keypress', e => {
	if (e.keyCode === 13 && (e.shiftKey || e.ctrlKey || e.metaKey)) comp();
});

$("#asm").addEventListener('keypress', e => {
	if (e.keyCode === 13 && (e.shiftKey || e.ctrlKey || e.metaKey)) assemble();
});

function changeTabs(e) {
  const target = e.target;
  const parent = target.parentNode;
  const grandparent = parent.parentNode;

  // Remove all current selected tabs
  parent
    .querySelectorAll('[aria-selected="true"]')
    .forEach((t) => t.setAttribute("aria-selected", false));

  // Set this tab as selected
  target.setAttribute("aria-selected", true);

  // Hide all tab panels
  grandparent
    .querySelectorAll('[role="tabpanel"]')
    .forEach((p) => p.setAttribute("hidden", true));

  // Show the selected panel
  grandparent.parentNode
    .querySelector(`#${target.getAttribute("aria-controls")}`)
    .removeAttribute("hidden");
}


function updateDebuggerState(vm) {

	$("#registers").innerText = '';
	for (let i = 0; i < vm.registers.length; ++i) {
		let address = -i - 1;
		let d = $("#registers").appendChild(document.createElement('pre'));
		d.innerText = `${((REGISTER_NAMES[address] || i) + ' '.repeat(12)).substr(0,12)} $${('0000'+vm.registers[i].toString(16)).substr(-4)} ${vm.registers[i]}`;
	}

	$("#codepoint").innerText = '';
	for (let p = -3; p <= 3; ++p) {
		let d = $("#codepoint").appendChild(document.createElement('pre'));
		d.innerText = (vm.pc + p < 0 ? ' ' : asm.disassemble(vm.pc + p)) + '\n';
		if (p === 0) d.style.backgroundColor="yellow";
	}

	$("#stackdepth").innerText = vm.memory.length - vm.sp;
	$("#stack").innerText = '';
	for (let i = Math.min(vm.sp + 5, vm.memory.length - 1); i >= vm.sp; --i) {
		let d = $("#stack").appendChild(document.createElement('pre'));
		d.innerText = `${('000' + i).substr(-4)}: $${('0000'+vm.memory[i].toString(16)).substr(-4)} ${vm.memory[i]}`;
		if (i === vm.sp) d.style.backgroundColor="yellow";
	}

	$("#memory").innerText = '';
	for (let i = 0; i < 100; ++i) {
		let d = $("#memory").appendChild(document.createElement('pre'));
		d.innerText = `${('000' + i).substr(-4)}: $${('0000'+vm.memory[i].toString(16)).substr(-4)} ${vm.memory[i]}`;
	}
}


function updateCharacterSheet(state) {


	function unhilite() {
		$$('.changed').forEach(elt => elt.classList.remove('changed'));
		updateCharacterSheet.UNHILITE = null;
	}

	unhilite();

	function set(id, value) {
		value = value.toString();
		let elt = document.getElementById(id);
		if (elt.innerText !== value) {
			elt.innerText = value;
			if (!updateCharacterSheet.UNHILITE) {
				updateCharacterSheet.UNHILITE = setTimeout(unhilite, 1000);
			}
			elt.classList.add('changed');
		}
	}
	set('race', Game.RACE_NAMES[state[RACE]]);
	set('level', state[LEVEL]);
	set('xp', state[XP]);
	set('health', `${state[MAX_HP]-state[DAMAGE]} / ${state[MAX_HP]}`);
	set('energy', `${state[MAX_MP]-state[FATIGUE]} / ${state[MAX_MP]}`);
	for (let i = 0; i < STAT_COUNT; ++i) {
		set('s' + i, state[STAT_0 + i] >> 8);
	}
	let n_spells = 0;
	for (let i = 0; i < SPELL_COUNT; ++i) {
		let l = state[SPELL_0 + i] >> 8;
		if (l) {
			set('bt' + n_spells, `Spell #${i}`);
			set('b' + n_spells, l);
			n_spells += 1;
		}
	}
	for (let i = 0; i < EQUIPMENT_COUNT; ++i) {
		set('e' + i, `+${state[EQUIPMENT_0 + i]} dagger`);
	}
	set('armorClass', state[ARMOR_CLASS]);

	for (let i = 0; i < INVENTORY_COUNT; ++i) {
		set('i' + i, state[INVENTORY_0 + i]);
	}
	set('encumbrance', state[ENCUMBRANCE]);
	set('capacity', state[CAPACITY]);

	if (!state[LEVEL]) return;

	let local = Game.MAP[state[LOCATION]];
	set('location', local.index);
	set('longitude', local.longitude || (local.index % 6));
	set('latitude', local.latitude || (local.index / 6) >> 0);
	set('locale', local.name);
	set('terrain', Game.TERRAIN_TYPES[local.terrain].name);
	set('mob', state[MOB_TYPE] ?
		`${Game.MOBS[state[MOB_TYPE]].name} (level ${state[MOB_LEVEL]})` : '');
	set('mobDamage', state[MOB_TYPE] ? state[MOB_DAMAGE] : '');

	let questal = Game.MAP[state[QUEST_LOCATION]];
	let original = Game.MAP[state[QUEST_ORIGIN]];
	set('questobject', state[QUEST_OBJECT]);
	set('questlocation', questal && (questal.name + ' #' + questal.index) || '');
	set('questprogress', `${state[QUEST_PROGRESS]} / ${state[QUEST_QTY]}`);
	set('questorigin', original && (original.name + ' #' + original.index) || '');

	set('act', state[ACT] || 'Prologue');
	set('actprogress', `${state[ACT_PROGRESS]} / ${state[ACT_DURATION]}`);
	set('gameprogress', `${Math.round(100 * state[ACT] / 10)}%`);

}


function gameplay(inst, arg1, arg2) {
	arg1 = arg1 || eval($("#arg1").value);
	arg2 = arg2 || eval($("#arg2").value);
	let result = Game.handleInstruction(vm.state, inst, arg1, arg2);
	$("#result").innerText = result;
	updateCharacterSheet(vm.state);
}
</script>